#####################################################################
#  Gantry Adjustment Routines
#####################################################################
[quad_gantry_level]
##  Min & Max gantry corners - measure from nozzle to respective belt positions
gantry_corners:
	-56,-1
	340,380
##  Probe points; this are nozzel positions we need to substract the probe offset
points:
	50,25
	50,250
	240,250
	240,25
speed: 300
horizontal_move_z: 15
retries: 5
retry_tolerance: 0.01
max_adjust: 17

#####################################################################
#  Macros
#####################################################################
[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: _QUAD_GANTRY_LEVEL
gcode:
  {% set user   = printer['gcode_macro _USER_VARIABLE'] %}
  {% if "xyz" not in printer.toolhead.homed_axes %} G28 {% endif %}
  # If QGL is not applied, first run a course calibration
  {% if printer.quad_gantry_level.applied == False %}
    _QUAD_GANTRY_LEVEL RETRY_TOLERANCE=1.0
  {% endif %}
  # then perform fine QGL down to desired spec
  # this has to be a separate macro call so the results of the above call will be visible!
  _FINE_QUAD_GANTRY_LEVEL
  G90
  G0 X{user.park.bed.x} Y{user.park.bed.y} Z{user.park.bed.z} F{user.speed.travel}

[gcode_macro _FINE_QUAD_GANTRY_LEVEL]
gcode:
    {% if printer.quad_gantry_level.applied == True %}
        # go for full quality at reduced probing height
        _QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=1.0  # <- set your preferred probing height here!
    {% else %}
        # This should never happen, just perform the full calibration using the defaults
        {action_respond_info("Fine QGL called without calling course QGL first!")}
        _QUAD_GANTRY_LEVEL  # default behavior, no speedup
    {% endif %}

# [gcode_macro CHECK_QGL]
# description: Run after QUAD_GANTRY_LEVEL to insure it passes
# gcode:
#   {% set user        = printer['gcode_macro _USER_VARIABLE'] %}
#   {% set probe_state = printer['gcode_macro _MAG_PROBE'].state|default('unknown')|lower %} ; get probe state
#   {% set probe_ok    = False if user.hw.mag_probe.ena and (probe_state == 'error' or probe_state == 'unknown')
#                   else True %}  
#   {% if not printer.quad_gantry_level.applied or not probe_ok %} ; check QGL and probe status
#     {action_respond_info("QGL CHECK: Fail therefore cancel the print")}
#     PAUSE_BASE
#     G90
#     G0 Z{user.z_hop} F{user.speed.z_hop}                                 ; move nozzle to z high first
#     {% if not printer.gcode_move.absolute_coordinates %} G91 {% endif %} ; set back to relative
#     {% if user.hw.mag_probe.ena %} DETACH_PROBE {% endif %}
#     CANCEL_PRINT PARK=1 ERROR=1
#   {% else %}
#     {action_respond_info("QGL CHECK: Pass")}
#   {% endif %}